{"title":"记一次Typora的逆向工程","uid":"b2fc974b964886354c4181c86e061189","slug":"记一次Typora的逆向工程","date":"2021-12-31T04:30:51.000Z","updated":"2022-03-21T12:40:34.572Z","comments":true,"path":"api/articles/记一次Typora的逆向工程.json","keywords":null,"cover":"https://cdn.jsdelivr.net/gh/TLHorse/TLBlogBed@master/2021/12/11/typora-product.png","content":"<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><p>学业负担逐渐加重，好久没有整逆向工程了。</p>\n<p>正巧最近我用的Markdown编辑器发布了1.0版本，到官网看看，发现开始收费了，售价 $14.99 ，最多三台设备。可以先进行试用，试用期到了，就需要付费。抱着试试看的心态，今天就拿Typora Mac练练手。</p>\n<h1 id=\"分析\"><a href=\"#分析\" class=\"headerlink\" title=\"分析\"></a>分析</h1><p>把Typora丢进Hopper里分析一波。对于这个简单轻量级的软件，我很容易就可以搜到关键词。拿subscription、trial、days、license这些敏感词试一试，就可以发现一些相关的OC类，例如<code>LicenseManager</code>和<code>LicenseWindowController</code>。我将一些之后需要逆向的函数加了黑。</p>\n<img src=\"https://cdn.jsdelivr.net/gh/TLHorse/TLBlogBed@master/2021/12/11/typora-search.png\" alt=\"搜索关键词\" style=\"zoom:50%;\" />\n\n<p>先打开<code> -[LicenseManager hasLicense]</code>，看上去是判断是否有许可证的函数。生成伪代码，很容易发现是个简单的逻辑判断流程，rax寄存器储存返回值。</p>\n<pre class=\"line-numbers language-objc\" data-language=\"objc\"><code class=\"language-objc\">&#x2F;* @class LicenseManager *&#x2F;\n-(char)hasLicense &#123;\n    rdi &#x3D; self-&gt;_hasLicense;\n    if (rdi !&#x3D; 0x0) &#123;\n            rax &#x3D; [rdi boolValue];\n            rax &#x3D; rax !&#x3D; 0x0 ? 0x1 : 0x0;\n    &#125;\n    else &#123;\n            rax &#x3D; 0x1;\n    &#125;\n    rax &#x3D; rax &amp; 0xff;\n    return rax;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>我们直接在汇编中按下<kbd>Option+A</kbd>，输入<code>mov rax, 0x1; ret</code>进行暴破，如图。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/TLHorse/TLBlogBed@master/2021/12/11/typora-bp.png\" alt=\"暴破\"></p>\n<p>接下来，用调试器运行。很讽刺的一件事是，试用期提醒的弹窗直接消失了。我把系统时间往后调，软件仍然可以正常运行，这不是伪破解。所以，这就破解完了……</p>\n<p>但是，还有一件事。我发现虽然暴破的软件可以正常使用，但是菜单栏上有个“查看许可证”按钮。点开它，软件就会检测出，剩余试用天数已经归零，此时弹出的窗口只有激活和退出两个按钮。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/TLHorse/TLBlogBed@master/2021/12/11/typora-licensebt.png\" alt=\"“查看许可证”按钮\"></p>\n<p>为了防止误触这个键，就得把对话框去掉。我不想再tweak试用天数了，更懒得写注册机，所以我准备让它弹出另一个对话框，显示软件已破解。</p>\n<h1 id=\"逆向\"><a href=\"#逆向\" class=\"headerlink\" title=\"逆向\"></a>逆向</h1><p>既要暴破软件，还要加对话框，我就用了动态库注入破解。我用的是<code>MonkeyDev</code>框架，也就是<code>substrate</code>。先新建<code>MonkeyAppMac</code>工程，命名<code>TyporaTweak</code>，然后将Typora拖进<code>TargetApp</code>，最后打开<code>TyporaTweak.m</code>文件。</p>\n<p>先写两个替代函数：</p>\n<pre class=\"line-numbers language-objc\" data-language=\"objc\"><code class=\"language-objc\">#include &lt;Cocoa&#x2F;Cocoa.h&gt; &#x2F;&#x2F; 记得引入Cocoa\n\n@class LicenseManager; &#x2F;&#x2F; 定义类\n\n&#x2F;&#x2F; hook是否有许可证\nstatic char new_hasLicense(LicenseManager* self, SEL _cmd) &#123;\n    return 1;\n&#125;\n\n&#x2F;&#x2F; hook许可证弹窗\nstatic void new_showLicense(LicenseManager* self, SEL _cmd, char arg2)&#123;\n \t  &#x2F;&#x2F; 新建一个警告弹窗\n    NSString *message &#x3D; @&quot;您正在使用Typora破解版&quot;;\n    NSAlert *alert &#x3D; [NSAlert new];\n    [alert addButtonWithTitle:@&quot;知道了&quot;];\n    [alert setMessageText:message];\n    [alert setAlertStyle:NSAlertStyleCritical];\n    [alert runModal];\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>然后在动态库加载入口hook（一些基本的语法，可在官网上搜索，不再解释）：</p>\n<pre class=\"line-numbers language-objc\" data-language=\"objc\"><code class=\"language-objc\">static void __attribute__((constructor)) initialize(void) &#123;\n    MSHookMessageEx(objc_getClass(&quot;LicenseManager&quot;), @selector(hasLicense), (IMP)&amp;new_hasLicense, NULL);\n    MSHookMessageEx(objc_getClass(&quot;LicenseManager&quot;), @selector(showLicense:), (IMP)&amp;new_showLicense, NULL);\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>所有的代码看起来像这样：</p>\n<pre class=\"line-numbers language-objc\" data-language=\"objc\"><code class=\"language-objc\">#import &quot;TyporaTweak.h&quot;\n#import &quot;substrate.h&quot;\n#include &lt;Cocoa&#x2F;Cocoa.h&gt;\n\n@class LicenseManager;\n\nstatic char new_hasLicense(LicenseManager* self, SEL _cmd) &#123;\n    return 1;\n&#125;\n\nstatic void new_showLicense(LicenseManager* self, SEL _cmd, char arg2)&#123;\n    NSString *message &#x3D; @&quot;您正在使用Typora破解版&quot;;\n    NSAlert *alert &#x3D; [NSAlert new];\n    [alert addButtonWithTitle:@&quot;知道了&quot;];\n    [alert setMessageText:message];\n    [alert setAlertStyle:NSAlertStyleCritical];\n    [alert runModal];\n&#125;\n\nstatic void __attribute__((constructor)) initialize(void) &#123;\n    MSHookMessageEx(objc_getClass(&quot;LicenseManager&quot;), @selector(hasLicense), (IMP)&amp;new_hasLicense, NULL);\n    MSHookMessageEx(objc_getClass(&quot;LicenseManager&quot;), @selector(showLicense:), (IMP)&amp;new_showLicense, NULL);\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>运行一下，大功告成！</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/TLHorse/TLBlogBed@master/2021/12/11/typora-product.png\" alt=\"typora破解后\"></p>\n<h1 id=\"动态库注入\"><a href=\"#动态库注入\" class=\"headerlink\" title=\"动态库注入\"></a>动态库注入</h1><p>拿到了<code>libTyporaTweak.lib</code>，就可以对二进制注入了。</p>\n<pre class=\"line-numbers language-sh\" data-language=\"sh\"><code class=\"language-sh\">.&#x2F;insert_dylib &lt;动态库路径&gt; &lt;Mach-O&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>但MonkeyDev已经帮我们完成了这一步。将Typora.app从TargetApp文件夹里拖出，即是我们的成品。</p>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><p>Typora就这么被逆向完了。不得不说，它在反破解方面还有待提高。没有反调试、没有加密加壳，什么都没有。这是值得开发者维护的地方。但就软件本身而言，它的确是个良心的Markdown编辑器，值得我们去购买支持。</p>\n","text":"前言学业负担逐渐加重，好久没有整逆向工程了。 正巧最近我用的Markdown编辑器发布了1.0版本，到官网看看，发现开始收费了，售价 $14.99 ，最多三台设备。可以先进行试用，试用期到了，就需要付费。抱着试试看的心态，今天就拿Typora Mac练练手。 分析把Typora丢...","link":"","photos":[],"count_time":{"symbolsCount":"3.2k","symbolsTime":"3 mins."},"categories":[{"name":"计算机","slug":"计算机","count":24,"path":"api/categories/计算机.json"}],"tags":[{"name":"反编译","slug":"反编译","count":16,"path":"api/tags/反编译.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%89%8D%E8%A8%80\"><span class=\"toc-text\">前言</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%88%86%E6%9E%90\"><span class=\"toc-text\">分析</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E9%80%86%E5%90%91\"><span class=\"toc-text\">逆向</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%8A%A8%E6%80%81%E5%BA%93%E6%B3%A8%E5%85%A5\"><span class=\"toc-text\">动态库注入</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%80%BB%E7%BB%93\"><span class=\"toc-text\">总结</span></a></li></ol>","author":{"name":"TLHorse","slug":"blog-author","avatar":"https://cdn.jsdelivr.net/gh/TLHorse/TLBlogBed@master/blog_img/avatar.jpg","link":"/","description":"","socials":{"github":"https://github.com/TLHorse","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/qq_45415111","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"破解一下学校的微机练习软件","uid":"7e603a51e1efa3dc095aed03c859c165","slug":"破解一下学校的微机练习软件","date":"2022-01-20T05:25:35.000Z","updated":"2022-03-21T05:14:38.907Z","comments":true,"path":"api/articles/破解一下学校的微机练习软件.json","keywords":null,"cover":"https://cdn.jsdelivr.net/gh/TLHorse/TLBlogBed@master/2022/01/20/ec-success.png","text":"前言如题，这次我来破解一下学校的微机练习软件。众所周知，我的逆向技术帖主要面向macOS和Linux，Windows逆向接触比较少，这次也是第一次破解Windows软件。因此技术方面的问题还请论坛的大佬指点。 分析说句没用的，学校的微机练习软件是用来练习微机中考的（我们这个省有）...","link":"","photos":[],"count_time":{"symbolsCount":730,"symbolsTime":"1 mins."},"categories":[{"name":"计算机","slug":"计算机","count":24,"path":"api/categories/计算机.json"}],"tags":[{"name":"反编译","slug":"反编译","count":16,"path":"api/tags/反编译.json"}],"author":{"name":"TLHorse","slug":"blog-author","avatar":"https://cdn.jsdelivr.net/gh/TLHorse/TLBlogBed@master/blog_img/avatar.jpg","link":"/","description":"","socials":{"github":"https://github.com/TLHorse","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/qq_45415111","juejin":"","customs":{}}}},"next_post":{"title":"街景一角","uid":"98c2346bf2025ee3d0829e87460fcb1d","slug":"街景一角","date":"2021-12-12T11:21:45.000Z","updated":"2022-03-20T08:02:32.126Z","comments":true,"path":"api/articles/街景一角.json","keywords":null,"cover":null,"text":"宽阔的街道、热闹的街景，人行道旁是一排景气的商铺，然而她的小摊只占一角。 天空中压根就没有月亮，而是乌漆墨黑的一片；嘴边的空气寒冷得如刀锋割人，夹杂着一大把一大把呛鼻的灰。我每晚放学，上了人行道，闭着眼都能猜到，她准在一旁卖零食——一位开三轮车的老奶奶，三轮车就是她琳琅满目的货摊...","link":"","photos":[],"count_time":{"symbolsCount":658,"symbolsTime":"1 mins."},"categories":[{"name":"随笔","slug":"随笔","count":33,"path":"api/categories/随笔.json"}],"tags":[{"name":"记叙文","slug":"记叙文","count":11,"path":"api/tags/记叙文.json"}],"author":{"name":"TLHorse","slug":"blog-author","avatar":"https://cdn.jsdelivr.net/gh/TLHorse/TLBlogBed@master/blog_img/avatar.jpg","link":"/","description":"","socials":{"github":"https://github.com/TLHorse","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/qq_45415111","juejin":"","customs":{}}}}}